<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Cat Pics 🐈</title>
<style>
  :root{
    --bg:#fafafa; --fg:#222; --card:#fff;
    --gap:.5rem; --radius:8px;
  }
  @media (prefers-color-scheme:dark){
     :root{ --bg:#121212; --fg:#eee; --card:#1e1e1e; }
  }
  body.dark{ --bg:#121212; --fg:#eee; --card:#1e1e1e; }
  body{
    margin:0 auto; max-width:900px; background:var(--bg); color:var(--fg);
    font-family:system-ui,-apple-system; padding:var(--gap);
    transition:background .25s;
  }
  header{display:flex; align-items:center; justify-content:space-between}
  #grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); gap:var(--gap)}
  .card{
    background:var(--card); border-radius:var(--radius); overflow:hidden;
    opacity:0; animation:fade .4s forwards;
  }
  @keyframes fade{to{opacity:1}}
  .card img{width:100%; display:block; cursor:zoom-in}
  #lightbox{
    position:fixed; inset:0; background:rgba(0,0,0,.85);
    display:flex; align-items:center; justify-content:center;
    opacity:0; pointer-events:none; transition:opacity .25s;
  }
  #lightbox.show{opacity:1; pointer-events:auto}
  #lightbox img{max-width:90%; max-height:90%; border-radius:var(--radius)}
  #dropZone{
    border:2px dashed var(--fg); border-radius:var(--radius);
    padding:2rem; text-align:center; margin-block:1rem;
  }
  #dropZone.dragover{background:var(--card)}
  button,input{font-size:1rem; padding:.4rem .6rem}
  .hidden{display:none}
</style>
</head>
<body>
<header>
  <h1>Cat Pics 🐈</h1>
  <div>
    <button id="addBtn">+ Add</button>
    <button id="darkBtn">🌗</button>
  </div>
</header>

<input type="file" accept="image/*" id="fileIn" class="hidden" multiple/>
<div id="dropZone">Drop images here or paste (<kbd>Ctrl+V</kbd>)</div>
<section id="grid"></section>

<div id="lightbox"><img src="" alt=""/></div>

<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script>
/* ---------- config ---------- */
const store   = localforage.createInstance({name:"catPics"});
const grid    = document.getElementById('grid');
const fileIn  = document.getElementById('fileIn');
const lightbox= document.getElementById('lightbox');
const lbImg   = lightbox.querySelector('img');
let   count   = 0;

/* ---------- utils ---------- */
const $ = q=>document.querySelector(q);
const compress = (file, maxW=300)=>new Promise(res=>{
  const img=new Image(), c=document.createElement('canvas'), ctx=c.getContext('2d');
  img.onload=()=>{
    const ratio=img.height/img.width;
    c.width=maxW; c.height=maxW*ratio;
    ctx.drawImage(img,0,0,c.width,c.height);
    res(c.toDataURL('image/jpeg',.7));
  };
  img.src=URL.createObjectURL(file);
});

/* ---------- render ---------- */
async function loadCats(){
  grid.innerHTML='';
  await store.iterate(async (data,key)=>{
    const [thumb, full] = data;
    const card=document.createElement('div');
    card.className='card';
    card.innerHTML=`<img src="${thumb}" data-full="${full}" alt="cat"/>`;
    grid.appendChild(card);
  });
}
loadCats();

/* ---------- add cats ---------- */
async function saveCat(file){
  const thumb=await compress(file);
  const full=await file.text().then(t=>URL.createObjectURL(file)); // keep blob url for now
  await store.setItem(`${Date.now()}_${file.name}`, [thumb, full]);
  loadCats();
}
fileIn.onchange=()=>[...fileIn.files].forEach(saveCat);
$('#addBtn').onclick=()=>fileIn.click();

/* ---------- drag & drop + paste ---------- */
const dz=$('#dropZone');
['dragenter','dragover','dragleave','drop'].forEach(ev=>{
  dz.addEventListener(ev, e=>{ e.preventDefault(); dz.classList.toggle('dragover',ev=='dragenter'||ev=='dragover'); });
});
dz.addEventListener('drop',e=>{
  [...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')).forEach(saveCat);
});
window.addEventListener('paste',e=>{
  [...e.clipboardData.files].filter(f=>f.type.startsWith('image/')).forEach(saveCat);
});

/* ---------- lightbox ---------- */
grid.addEventListener('click',e=>{
  if(e.target.tagName==='IMG'){
    lbImg.src=e.target.dataset.full || e.target.src;
    lightbox.classList.add('show');
  }
});
lightbox.addEventListener('click',()=>lightbox.classList.remove('show'));

/* ---------- dark mode ---------- */
$('#darkBtn').onclick=()=>document.body.classList.toggle('dark');

/* ---------- service worker cache (offline) ---------- */
if('serviceWorker' in navigator){
  const sw='data:text/javascript,'+encodeURIComponent(`
    const CACHE='cat-v1';
    self.addEventListener('install',e=>e.waitUntil(caches.open(CACHE).then(c=>c.addAll(['/']))));
    self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
  `);
  navigator.serviceWorker.register(sw);
}
</script>
</body>
</html>
